main:
  params: [input]
  steps:
    - init:
        assign:
          - workflow_name: "ingesta_jtalent"
          - project_id: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}

    - log_start:
        call: sys.log
        args:
          severity: "INFO"
          json:
            message: ${"[WF-ING] Workflow " + workflow_name + " starting. Input=" + json.encode_to_string(input)}

    - try_call_cf:
        try:
          call: http.post
          args:
            url: ${"https://cf-proyectofinal-157229630236.europe-west1.run.app"}
            auth:
              type: OIDC
            timeout: 1800
            body: ${input}
          result: resp
        except:
          as: error_cf
          steps:
            - log_error_cf:
                call: sys.log
                args:
                  severity: "ERROR"
                  json:
                    message: ${"[WF-ING] Error calling Cloud Function"}
            - log_error_cf_payload:
                call: sys.log
                args:
                  severity: "ERROR"
                  json: ${error_cf}
            - raise_fail_cf:
                raise: "Error calling Cloud Function for ingestion"

    - check_status:
        switch:
          - condition: ${resp.body.ok}
            next: log_success
        next: log_partial_failure

    - log_success:
        call: sys.log
        args:
          severity: "INFO"
          json:
            message: ${"[WF-ING] Ingestion completed OK. Results=" + json.encode_to_string(resp.body.results)}
        next: end_workflow

    - log_partial_failure:
        call: sys.log
        args:
          severity: "WARNING"
          json:
            message: ${"[WF-ING] Ingestion completed with one or more failed endpoints. Response=" + json.encode_to_string(resp.body)}
        next: end_workflow

    - end_workflow:
        return: ${"Workflow finished. See logs for detailed endpoint status."}
